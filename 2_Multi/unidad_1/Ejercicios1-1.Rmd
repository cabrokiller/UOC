---
title: "unidad 1"
output: html_notebook
---

# 1. Estadísticos
## 1. Para la base de datos crabs del paquete MASS de R:
a) Estudiar la base de datos con la ayuda y las funciones str() y summary().
b) Calcular estadísticos descriptivos como la media, la mediana, la varianza, etc. de las variables numéricas, tanto para todos los datos, como para las especies y los sexos por separado.
c) Hallar los cinco números descriptivos de cada variable numérica. Utilizar la función fivenum().
d) Hallar las matrices de varianzas y covarianzas de las variables numéricas según especie y sexo
e) Comparar cada especie con medidas globales de variabilidad: varianza total tr(S), varianza
media tr(S)/p, varianza generalizada |S| y varianza efectiva |S| 1/p.


```{r}
pacman::p_load(MASS, tidyverse)

# a)
str(crabs)
summary(crabs)

# b)
summ <- function(df) {
    df %>%
        summarise(
            p25 = quantile(value, probs = 0.25),
            mean = mean(value),
            median = median(value),
            p75 = quantile(value, probs = 0.75),
            sd = sd(value),
            var = var(value)
        )
}


db <-
    crabs %>%
    select(-index) %>%
    gather(key, value, -sp, -sex)
    
db %>%
    group_by(key) %>%
    summ()

db %>%
    group_by(sp, key) %>%
    summ()

db %>%
    group_by(sex, key) %>%
    summ()

# c) 
crabs %>%
    select(FL:BD) %>%
    map_df(~ fivenum(.x))
    

# d)
crabs %>%
    filter(sex == "M") %>%
    select(FL:BD) %>%
    cov()

crabs %>%
    filter(sex == "F") %>%
    select(FL:BD) %>%
    cov()


(cov_spO <- 
    crabs %>%
    filter(sp == "O") %>%
    select(FL:BD) %>%
    cov())

(cov_spB <- 
crabs %>%
    filter(sp == "B") %>%
    select(FL:BD) %>%
    cov())

# e)
covs <- list(cov_spO, cov_spB)
p <- length(crabs)

## varianza total tr(S)
sapply(covs, function(x) sum(diag(x)))

## varianza media tr(S)/p
sapply(covs, function(x) sum(diag(x)) / p)

## varianza generalizada
sapply(covs, det)

## varianza efectiva
sapply(covs, function(x) det(x)^1/p)
```






## 2. (∗) Para la base de datos huswif del libro de Everitt(2005)2
a) Cargar los datos con la instrucción: huswif <- source("chap1huswif.dat")$value y estudiar la base de datos con las funciones str() y summary().
b) Calcular estadísticos descriptivos como la media, la mediana, la varianza, etc. de todas las variables.
c) Hallar los cinco números descriptivos de cada variable numérica. Utilizar la función fivenum().
d) Hallar la matriz de varianzas-covarianzas y la matriz de correlaciones.
e) Hallar las medidas globales de variabilidad: varianza total tr(S), varianza media tr(S)/p, varianza generalizada |S| y varianza efectiva |S|
1/p
.

## 3. (∗) Para la base de datos airpoll del libro de Everitt(2005).
a) Cargar los datos con la instrucción: 
`airpoll <- source("chap2airpoll.dat")$value` y estudiar la base de datos con las funciones str() y summary().
b) Calcular estadísticos descriptivos como la media, la mediana, la varianza, etc. de todas las variables.
c) Hallar los cinco números descriptivos de cada variable numérica. Utilizar la función fivenum().
d) Hallar la matriz de varianzas-covarianzas y la matriz de correlaciones.
e) Hallar las medidas globales de variabilidad: varianza total tr(S), varianza media tr(S)/p, varianza generalizada |S| y varianza efectiva |S| 1/p.


4. Entre los 10 elementos muestrales o parejas casadas (con papeles o no) de la base de datos huswif
del libro de Everitt(2005):
a) Calcular las distancias euclídeas con la función dist de R y expresarlas en forma de matriz.
b) Calcular las distancias de K.Pearson y dar la matriz de distancias.
c) Calcular la distancia de Mahalanobis (sin cuadrado) entre la primera y la última de las parejas
(huswif[1,] y huswif[10,]).
d) Calcular las distancias al cuadrado de Mahalanobis de cada pareja al vector de medias y su
correspondiente matriz de covarianzas. Probar ?mahalanobis en R.
e) Realizar un qqplot entre los cuantiles de una distribución ji-cuadrado con 5 grados de libertad
y las distancias al cuadrado de Mahalanobis. ¿Se ajustan?
También se puede utilizar la función chisplot de Everitt.
5. (∗) Estudiar el ajuste de las distancias al cuadrado de Mahalanobis para los datos de airpoll del
libro de Everitt a una distribución ji-cuadrado.
Utilizar un qqplot o un chisplot de Everitt. También podemos utilizar el gráfico de la función
outlier del paquete psych.
6. Con la base de datos huswif del libro de Everitt(2005):
a) Realizar una estandarización univariante del tipo
y = D
−1/2
(x − x¯)
donde D
−1/2 = diag(s
−1
1
, . . . , s−1
p
) y obtener la base de datos transformada.
b) Realizar una estandarización multivariante del tipo
y = S
−1/2
(x − x¯)
c) Observar que la distancia euclídea entre las filas de datos tras la estandarización multivariante
coinciden con la distancia de Mahalanobis de los datos originales.
7. Comprobar que la desviación típica generalizada en el caso de dos variables es
|S|
1/2 = sxsy
p
1 − r
2
donde s
2
x y s
2
y
son las varianzas muestrales de las dos variables y r el coeficiente de correlación.
8. Medidas de dependencia lineal con las variables numéricas de la base de datos crabs del paquete
MASS de R, únicamente para los datos de la especie Blue y sexo Macho:
a) Hallar la correlación entre las variables CL i CW.
Calcular la matriz de correlaciones R de todas las variables numéricas.
b) Hallar la correlación múltiple entre la variable BD y el resto.
c) El coeficiente de correlación parcial es una medida de dependencia directa entre dos variables.
Se sabe que rij.k1...kq = −
s
ij
√
s
iis
jj donde s
ij son los elementos de la matriz S
−1
, llamada matriz
de precisión. Calcular la matriz de correlaciones parciales
P = (−1)∗diag(S
−1
)
−1/2S
−1
diag(S
−1
)
−1/2
donde (−1)∗
es el producto por −1 de todos los elementos excepto los de la diagonal. Comprobar que no es la inversa de la matriz de correlaciones R
−1
.


# 2. Gráficos
## 9. Con las variables CL y CW de la base de datos crabs del paquete MASS de R:
a) Crear el diagrama de dispersión de las dos variables y sus histogramas marginales.
b) Crear el diagrama de dispersión de las dos variables y sus diagramas de caja marginales.

```{r}
pacman::p_load(MASS, tidyverse, ggExtra)
p <- ggplot(data = crabs, aes(CL, CW)) + geom_point()

ggMarginal(p, type = "histogram")
```

```{r}
ggMarginal(p, type = "box")
```

## 10. Con la base de datos crabs del paquete MASS de R, realizar los siguientes diagramas de caja múltiples:
a) Para comparar las variables según especie.
b) Para comparar las variables según sexo.
c) Para comparar las variables según especie y sexo.

```{r}
# a) 
crabs %>%
    gather(key, value, -sex, -sp, -index) %>%
    ggplot(aes(key, value, color = sp)) +
    geom_boxplot() +
    scale_color_viridis_d(begin = .2, end = .8)

# b) 
crabs %>%
    gather(key, value, -sex, -sp, -index) %>%
    ggplot(aes(key, value, color = sex)) +
    geom_boxplot() +
    scale_color_viridis_d(begin = .2, end = .8)

# c) 
crabs %>%
    gather(key, value, -sex, -sp, -index) %>%
    unite(det, sp, sex) %>%
    ggplot(aes(key, value, color = det)) +
    geom_boxplot() +
    scale_color_viridis_d(end = .85)
```




## 11. Con la base de datos crabs del paquete MASS de R, realizar un matriz de diagramas de dispersión según especie y sexo con la instrucción pairs().
a) Añadir los histogramas de cada variable a la diagonal.
b) Añadir la recta de regresión a cada diagrama de dispersión.

```{r}
panel.hist <- function(x, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(usr[1:2], 0, 1.5) )
    h <- hist(x, plot = FALSE)
    breaks <- h$breaks; nB <- length(breaks)
    y <- h$counts; y <- y/max(y)
    rect(breaks[-nB], 0, breaks[-1], y, col = "darkgreen", ...)
}

crabs %>%
    filter(sex == 'M') %>%
    select(4:8) %>%
    pairs(., panel = panel.smooth, diag.panel = panel.hist)
crabs %>%
    filter(sex == 'F') %>%
    select(4:8) %>%
    pairs(., panel = panel.smooth, diag.panel = panel.hist)

crabs %>%
    filter(sp == 'B') %>%
    select(4:8) %>%
    pairs(., panel = panel.smooth, diag.panel = panel.hist)

crabs %>%
    filter(sp == 'O') %>%
    select(4:8) %>%
    pairs(., panel = panel.smooth, diag.panel = panel.hist)

```


## 12. Con la base de datos huswif del libro de Everitt(2005):
a) Calcular algún gráfico de dispersión 3D con la función scatterplot3d() del paquete scatterplot3d.
b) Realizar un gráfico de dispersión en dos dimensiones de las variables edad del marido y edad de la mujer. Añadir con la función symbols() la variable edad del marido en el primer matrimonio.

```{r}
source('https://www.york.ac.uk/depts/maths/data/everitt/chap1huswif.dat')
pacman::p_load(scatterplot3d)

# a)
scatterplot3d(huswif$Hage, huswif$Hage, huswif$Hagefm)

# b)
huswif %>%
    ggplot(aes(Hage, Wage)) + 
    geom_point() +
    geom_point(aes(x = Hagefm), shape = 3)

```

## 13. (*) Representar con caras de Chernoff las parejas de la base de datos huswif del libro de Everitt(2005).

```{r}
pacman::p_load(aplpack)
aplpack::faces(huswif)
```

## 14. (*) Representar con un gráfico de estrellas los vectores de medias de todas las variables numéricas de la base de datos crabs del paquete MASS de R en los cuatro grupos, según especie y sexo.4

```{r}
crabs %>%
    gather(key, value, -sex, -sp, -index) %>%
    group_by(sp, key) %>%
    summarise(mean = mean(value)) %>%
    ggplot(aes(key, mean, color = sp, group = sp)) +
    geom_line() +
    coord_polar() +
    scale_color_viridis_d(begin = .2, end = .8)

crabs %>%
    gather(key, value, -sex, -sp, -index) %>%
    group_by(sex, key) %>%
    summarise(mean = mean(value)) %>%
    ggplot(aes(key, mean, color = sex, group = sex)) +
    geom_line() +
    coord_polar() +
    scale_color_viridis_d(begin = .2, end = .8)
    
crabs %>%
    gather(key, value, -sex, -sp, -index) %>%
    group_by(sex, key) %>%
    summarise(mean = mean(value)) %>%
    spread(key, mean) %>%
    select(-sex) 
    
# stars
```





## 15. Señalar los datos atípicos en la base de datos crabs, únicamente para los datos de la especie Blue y sexo Macho:
a) Según un criterio univariante como donde med(x) es la mediana de las observaciones y MAD(x) la mediana de las desviaciones en valor absoluto respecto a la mediana.
b) Con otro criterio univariante como donde Q1,Q3 son los cuartiles y IQR el rango intercuartílico.
c) Con un criterio multivariante sencillo como 
1) Se busca el 50% de los datos con menor distancia de Mahalanobis al centro ¯x, media de todos los datos.
2) Se calculan la media ¯xR y la matriz de covarianzas SR con ese conjunto reducido de datos.


```{r}
crabs %>%
    filter(sp == "B", 
           sex == "M") %>%
    select(-sp, -sex, -index) %>%
    gather(key, value) %>%
    group_by(key) %>%
    mutate(median = median(value),
           mad = mad(value),
           val_med = (abs(value-median))/mad) %>%
    mutate(criteria = abs(value - median(value))/mad(value) > 5) %>%
    filter(criteria == T)

#star


#abs(xi - median(x))/mad(x) > 5
```


